<?xml version="1.0" ?>
<!--
     Copyright 2020, Data61, CSIRO (ABN 41 687 119 230)

     SPDX-License-Identifier: BSD-2-Clause
-->

<api name="ObjectApiAarch64" label_prefix="aarch64_">
    <struct name="seL4_UserContext">
        <member name="pc"/>
        <member name="sp"/>
        <member name="spsr"/>
        <member name="x0"/>
        <member name="x1"/>
        <member name="x2"/>
        <member name="x3"/>
        <member name="x4"/>
        <member name="x5"/>
        <member name="x6"/>
        <member name="x7"/>
        <member name="x8"/>
        <member name="x16"/>
        <member name="x17"/>
        <member name="x18"/>
        <member name="x29"/>
        <member name="x30"/>
        <member name="x9"/>
        <member name="x10"/>
        <member name="x11"/>
        <member name="x12"/>
        <member name="x13"/>
        <member name="x14"/>
        <member name="x15"/>
        <member name="x19"/>
        <member name="x20"/>
        <member name="x21"/>
        <member name="x22"/>
        <member name="x23"/>
        <member name="x24"/>
        <member name="x25"/>
        <member name="x26"/>
        <member name="x27"/>
        <member name="x28"/>
        <member name="tpidr_el0"/>
        <member name="tpidrro_el0"/>
    </struct>
    <interface name="seL4_ARM_VSpace" manual_name="Page Global Directory"
        cap_description="Capability to the top level translation table being operated on.">
        <method id="ARMVSpaceClean_Data" name="Clean_Data" manual_label="vspace_clean"
            manual_name="Clean Data">
                <brief>
                    Clean cached pages within a top level translation table
                </brief>
                <description>
                    <docref>See <autoref label="ch:vspace"/>.</docref>
                </description>
            <param dir="in" name="start" type="seL4_Word"
            description="Start address"/>
            <param dir="in" name="end" type="seL4_Word"
            description="End address"/>
            <error name="seL4_FailedLookup">
                <description>
                    The <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_IllegalOperation">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="end"/> is in the kernel virtual address range.
                </description>
            </error>
            <error name="seL4_InvalidArgument">
                <description>
                    The <texttt text="start"/> is greater than or equal to <texttt text="end"/>.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_RangeError">
                <description>
                    The specified range crosses a page boundary.
                </description>
            </error>
        </method>
        <method id="ARMVSpaceInvalidate_Data" name="Invalidate_Data"
            manual_name="Invalidate Data" manual_label="vspace_invalidate">
                <brief>
                    Invalidate cached pages within a top level translation table
                </brief>
             <description>
                 <docref>See <autoref label="ch:vspace"/>.</docref>
             </description>
            <param dir="in" name="start" type="seL4_Word"
            description="Start address"/>
            <param dir="in" name="end" type="seL4_Word"
            description="End address"/>
            <error name="seL4_FailedLookup">
                <description>
                    The <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_IllegalOperation">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="end"/> is in the kernel virtual address range.
                </description>
            </error>
            <error name="seL4_InvalidArgument">
                <description>
                    The <texttt text="start"/> is greater than or equal to <texttt text="end"/>.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_RangeError">
                <description>
                    The specified range crosses a page boundary.
                </description>
            </error>
        </method>
        <method id="ARMVSpaceCleanInvalidate_Data" name="CleanInvalidate_Data"
            manual_name="Clean and Invalidate Data" manual_label="vspace_clean_invalidate">
                <brief>
                    Clean and invalidate cached pages within a top level translation table
                </brief>
             <description>
                 <docref>See <autoref label="ch:vspace"/>.</docref>
             </description>
            <param dir="in" name="start" type="seL4_Word"
            description="Start address"/>
            <param dir="in" name="end" type="seL4_Word"
            description="End address"/>
            <error name="seL4_FailedLookup">
                <description>
                    The <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_IllegalOperation">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="end"/> is in the kernel virtual address range.
                </description>
            </error>
            <error name="seL4_InvalidArgument">
                <description>
                    The <texttt text="start"/> is greater than or equal to <texttt text="end"/>.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_RangeError">
                <description>
                    The specified range crosses a page boundary.
                </description>
            </error>
        </method>
        <method id="ARMVSpaceUnify_Instruction" name="Unify_Instruction"
            manual_name="Unify Instruction" manual_label="vspace_unify_instruction">
                <brief>
                    Clean and invalidate cached instruction pages to point of unification
                </brief>
             <description>
                 <docref>See <autoref label="ch:vspace"/>.</docref>
             </description>
             <param dir="in" name="start" type="seL4_Word"
             description="Start address"/>
             <param dir="in" name="end" type="seL4_Word"
	     description="End address"/>
            <error name="seL4_FailedLookup">
                <description>
                    The <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_IllegalOperation">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="end"/> is in the kernel virtual address range.
                </description>
            </error>
            <error name="seL4_InvalidArgument">
                <description>
                    The <texttt text="start"/> is greater than or equal to <texttt text="end"/>.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_RangeError">
                <description>
                    The specified range crosses a page boundary.
                </description>
            </error>
        </method>


        <method id="ARMVspaceRange_Remap" name = "Range_Remap"
            manual_name="Vspace Range Remap" manual_label="vspace_range_remap">
            <brief>
                Unmap or protect a range of pages in this vspace
            </brief>
            <description>
                Unmap/protect a range of pages in this vspace. This call can only decrease access to pages, not increase. 
            </description>
            <param dir="in" name="start_vaddr" type="seL4_Word"
                   description="The starting address of the first page to be considered. Should be page aligned"/>
            <param dir="in" name="n_pages" type="seL4_Uint8"
                   description="The maximum number of pages (of any size) to examine. Can be at most 32 pages. "/>
            <param dir="in" name="strip_rights" type="seL4_CapRights_t">
                <description>
                   The rights to strip from each page considered i.e. <texttt text="seL4_ReadOnly"/> strips read rights. 
                   If <texttt text="seL4_NoRightd"/> is the provided argument, this call will unmap the page instead.
                </description>
            </param>
            <param dir="out" name="end_vaddr" type="seL4_Word"
                   description="The staring address of the page after the one which was last considered "/>
            <param dir="out" name="num" type="seL4_Uint8"
                   description="The number of pages which were actually unmapped of the ones considered "/>
            <error name="seL4_FailedLookup">
                <description>
                    The <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                </description>
            </error>
            <error name="seL4_InvalidArgument">
            <description>
                <texttt text="start_vaddr"/> is beyond than the user addressable region. 
                Or, n_pages is greater than 32 pages.
            </description>
            </error>
            <error name="seL4_AlignmentError">
                <description>
                    The start vaddr is not page aligned.
                </description>
            </error>
        </method>
        <method id = "ARMVspacePage_Map" name = "Page_Map"
                manual_name="Vspace page map" manual_label="vspace_page_map">
            <brief>
                Map a frame to a virtual address in the provided vspace. 
            </brief>
            <description>
                Given a virtual address in the vspace, maps this virtual address to the frame with a given capability.  If the given virtual adress is already mapped to a different 
                frame, this mapping will be overwritten. If <texttt text="frame"/> is already mapped to a page but does not back it, the mapping will be considered stale and 
                overwritten. If the frame capability does back a page, the mapping will not be overwritten and this system call will fail. 
            </description>
            <param dir="in" name="frame" type="seL4_CPtr"
                    description="A capability to the frame which is to be used for the mapping"/>
            <param dir="in" name="vaddr" type="seL4_Word"
                    description="The virtual address of the start of the page which is to be mapped. Must be page-aligned"/>
            <param dir="in" name="rights" type="seL4_CapRights_t">
                <description>
                    "Rights for the mapping.<docref>Possible values for this type are given in <autoref label="sec:cap_rights"/>  .</docref>"
                </description>
            </param>
            <param dir="in" name="attr" type="seL4_ARM_VMAttributes">
                <description>
                    "VM Attributes for the mapping.<docref>Possible values for this type are given in <autoref label="ch:vspace"/>  .</docref>"
                </description>
            </param>
            <error name="seL4_AlignmentError">
            <description>
                The <texttt text="vaddr"/> is not aligned to the page size of <texttt text="frame"/>.
            </description>
            </error>
            <error name="seL4_FailedLookup">
                <description>
                    The <texttt text="_service"/> does not have a paging structure at the required level mapped at <texttt text="vaddr"/>.
                    Or, <texttt text="_service"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_InvalidArgument">
                <description>
                    The <texttt text="frame"/> is already backing a different page in <texttt text="_service"/>.
                    Or, <texttt text="vaddr"/> is in the kernel virtual address range.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="frame"/> or <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="_service"/> is not assigned to an ASID pool.
                    Or, <texttt text="frame"/> is already mapped in a different VSpace.
                </description>
            </error>
        </method>
    </interface>
    <interface name="seL4_ARM_PageUpperDirectory" manual_name="Page Upper Directory"
        cap_description="Capability to the upper page directory being operated on.">
        <method id="ARMPageUpperDirectoryMap" name="Map" condition="!(defined CONFIG_ARM_HYPERVISOR_SUPPORT &amp;&amp; defined CONFIG_ARM_PA_SIZE_BITS_40)">
                <brief>
                    Map an upper page directory
                </brief>
                <description>
                    Map an upper page directory (level 1) to a top level translation table (level 0).
                </description>
            <param dir="in" name="vspace" type="seL4_CPtr"
            description="Top level translation table. Must be assigned to an ASID pool."/>
            <param dir="in" name="vaddr" type="seL4_Word"
            description="Virtual address"/>
            <param dir="in" name="attr" type="seL4_ARM_VMAttributes">
                <description>
                    VM Attributes for the mapping.<docref>Possible values for this type are given in <autoref label="ch:vspace"/>  .</docref>
                </description>
            </param>
            <error name="seL4_DeleteFirst">
                <description>
                    A mapping already exists for this level in <texttt text="vspace"/> at <texttt text="vaddr"/>.
                </description>
            </error>
            <error name="seL4_FailedLookup">
                <description>
                    The <texttt text="vspace"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_IllegalOperation">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                </description>
            </error>
            <error name="seL4_InvalidArgument">
                <description>
                    The <texttt text="vaddr"/> is in the kernel virtual address range.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> or <texttt text="vspace"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="vspace"/> is not assigned to an ASID pool.
                    Or, <texttt text="_service"/> is already mapped in a VSpace.
                </description>
            </error>
        </method>
        <method id="ARMPageUpperDirectoryUnmap" name="Unmap"
            condition="!(defined CONFIG_ARM_HYPERVISOR_SUPPORT &amp;&amp; defined CONFIG_ARM_PA_SIZE_BITS_40)">
            <description>
                TODO
            </description>
            <error name="seL4_IllegalOperation">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                </description>
            </error>
            <error name="seL4_RevokeFirst">
                <description>
                    A copy of the <texttt text="_service"/> capability exists.
                </description>
            </error>
        </method>
    </interface>
    <interface name="seL4_ARM_PageDirectory" manual_name="Page Directory"
        cap_description="Capability to the page directory being operated on.">
        <method id="ARMPageDirectoryMap" name="Map">
                <brief>
                    Map a page directory
                </brief>
                <description>
                    Map a page directory (level 2) to an upper page directory (level 1).
                </description>
            <param dir="in" name="vspace" type="seL4_CPtr"
            description="Top level translation table. Must be assigned to an ASID pool."/>
            <param dir="in" name="vaddr" type="seL4_Word"
            description="Virtual adress"/>
            <param dir="in" name="attr" type="seL4_ARM_VMAttributes">
                <description>
                    VM Attributes for the mapping.<docref>Possible values for this type are given in <autoref label="ch:vspace"/>  .</docref>
                </description>
            </param>
            <error name="seL4_DeleteFirst">
                <description>
                    A mapping already exists for this level in <texttt text="vspace"/> at <texttt text="vaddr"/>.
                </description>
            </error>
            <error name="seL4_FailedLookup">
                <description>
                    The <texttt text="vspace"/> does not have a Page Upper Directory mapped at <texttt text="vaddr"/>.
                    Or, <texttt text="vspace"/> is not assigned to an ASID pool.
                </description>
            </error>
            <error name="seL4_IllegalOperation">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                </description>
            </error>
            <error name="seL4_InvalidArgument">
                <description>
                    The <texttt text="vaddr"/> is in the kernel virtual address range.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> or <texttt text="vspace"/> is a CPtr to a capability of the wrong type.
                    Or, <texttt text="vspace"/> is not assigned to an ASID pool.
                    Or, <texttt text="_service"/> is already mapped in a VSpace.
                </description>
            </error>
        </method>
        <method id="ARMPageDirectoryUnmap" name="Unmap">
                <brief>
                    Unmap a page directory
                </brief>
                <description>
                    Unmap a page directory (level 2) from an upper page directory (level 1)
                </description>
            <error name="seL4_IllegalOperation">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                </description>
            </error>
            <error name="seL4_InvalidCapability">
                <description>
                    The <texttt text="_service"/> is a CPtr to a capability of the wrong type.
                </description>
            </error>
            <error name="seL4_RevokeFirst">
                <description>
                    A copy of the <texttt text="_service"/> capability exists.
                </description>
            </error>
        </method>
    </interface>
</api>
